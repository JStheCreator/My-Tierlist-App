<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>My Own Tierlist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      font-family: 'Pretendard', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f9fafb;
      background: radial-gradient(circle at top left, #1ed76033, #121212 45%, #050505 80%);
      background-attachment: fixed;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }
    body.read-only .track-delete {
      display: none !important;
    }
    body.read-only .track-card {
      cursor: default;
    }

    .app-shell {
      width: 100%;
      max-width: 1280px;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    .glass-card {
      background: rgba(18, 18, 18, 0.92);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 18px;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .app-title {
      font-family: 'Space Grotesk', system-ui;
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .subtitle {
      font-size: 0.8rem;
      opacity: 0.0;
      height: 0;
      overflow: hidden;
    }

    .create-form {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }
    .create-form label {
      display: block;
      font-size: 0.8rem;
      margin-top: 6px;
      margin-bottom: 2px;
      opacity: 0.85;
    }
    .create-form input,
    .create-form select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: #181818;
      color: #e5e7eb;
      font-size: 0.82rem;
    }

    .btn {
      border: none;
      cursor: pointer;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.2s;
    }
    .btn-primary {
      margin-top: 12px;
      align-self: center;
      width: 70%;
      max-width: 220px;
      text-align: center;
      background: #1ed760;
      color: #121212;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    .btn-primary:hover { background: #1fdf64; transform: translateY(-1px); }

    .btn-danger {
      background: #ef4444;
      color: #f9fafb;
      padding: 6px 10px;
      border-radius: 999px;
    }
    .btn-danger:hover { background: #f97373; }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .btn-ghost:hover {
      background: #374151;
    }

    .section-title {
      margin-top: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
    }

    .tierlist-list {
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.8rem;
    }
    .tierlist-item {
      padding: 6px 8px;
      border-radius: 10px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #181818;
      border: 1px solid rgba(255, 255, 255, 0.06);
      cursor: pointer;
      transition: background 0.15s;
    }
    .tierlist-item span.type {
      font-size: 0.7rem;
      opacity: 0.7;
      text-transform: uppercase;
    }
    .tierlist-item:hover { background: #282828; }

    .pagination {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      font-size: 0.75rem;
    }
    .page-btn {
      border: none;
      background: transparent;
      color: #9ca3af;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
    }
    .page-btn.active {
      background: #1ed760;
      color: #111827;
      font-weight: 700;
    }
    .page-btn:hover {
      background: #374151;
      color: #e5e7eb;
    }

    .main {
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow-y: auto;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    .tier-title {
      font-size: 1.2rem;
      font-weight: 700;
    }
    .tier-meta {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .waiting-section { margin-bottom: 8px; }
    .waiting-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .waiting-header h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
    }
    .waiting-list {
      min-height: 80px;
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      border-radius: 12px;
      background: #181818;
      border: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .add-item-form {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-top: 8px;
      align-items: center;
    }
    .add-item-form input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #181818;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    .add-item-form .btn {
      height: 30px;
      font-size: 0.75rem;
    }

    .info-text {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 4px;
    }

    .tier-board {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tier-section {
      background: radial-gradient(circle at top left, #2a2a2a, #111);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 10px 12px 12px;
    }
    .tier-section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .tier-section-header.hof {
      border-left: 4px solid #1ed760;
      padding-left: 8px;
    }
    .tier-section-title {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .tier-section-sub {
      font-size: 0.7rem;
      opacity: 0.7;
    }
    .tier-dropzone.vertical {
      min-height: 56px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .tier-dropzone.drag-over {
      outline: 1px dashed rgba(255, 255, 255, 0.4);
      outline-offset: -3px;
    }

    .track-card {
      position: relative;
      display: grid;
      grid-template-columns: 48px 1fr auto;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 12px;
      background: linear-gradient(120deg, rgba(40,40,40,0.95), rgba(22,22,22,0.95));
      border: 1px solid rgba(255, 255, 255, 0.03);
      cursor: grab;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.18s ease;
      font-size: 0.8rem;
    }
    .track-card.dragging {
      opacity: 0.5;
      transform: scale(0.97);
    }
    .track-card:hover {
      background: linear-gradient(120deg, #272727, #181818);
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }
    .track-cover {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      object-fit: cover;
      background: #111;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }
    .track-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }
    .track-title {
      font-weight: 600;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .track-artist {
      font-size: 0.7rem;
      opacity: 0.8;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .track-score {
      min-width: 40px;
      text-align: right;
      font-weight: 700;
      font-size: 0.9rem;
      color: #1ed760;
      padding-left: 4px;
    }
    .badge-waiting {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
    }

    .track-delete {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 0.65rem;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .track-card:hover .track-delete {
      display: flex;
    }
    .waiting-list .track-card .track-delete {
      display: flex;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #181818;
      border-radius: 20px;
      padding: 16px;
      width: 320px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.85);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .modal-title {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .modal-body {
      font-size: 0.8rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .modal-close {
      border: none;
      background: transparent;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 1rem;
    }

    @media (max-width: 900px) {
      .app-shell { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="read-only">
  <div class="app-shell">
    <aside class="sidebar glass-card">
      <div>
        <div class="app-title">My Own Tierlist</div>
        <div class="subtitle"></div>
      </div>

      <form id="createForm" class="create-form">
        <label>이름 (작성자)</label>
        <input type="text" id="creatorName" placeholder="예: hyd" required />
        <label>비밀번호</label>
        <input type="password" id="creatorPassword" placeholder="수정용 비밀번호" required />
        <label>티어리스트 타입</label>
        <select id="tierType">
          <option value="song">노래 TierList</option>
          <option value="album">앨범 TierList</option>
          <option value="artist">아티스트 TierList</option>
        </select>
        <label>티어리스트 제목</label>
        <input type="text" id="tierTitle" placeholder="예: 2025 인생 노래 Top" required />
        <button type="submit" class="btn btn-primary">나만의 Tierlist 생성</button>
      </form>

      <div>
        <div class="section-title">나의 TierList</div>
        <div id="myTierlistList" class="tierlist-list"></div>

        <div class="section-title">공개 TierList</div>
        <div id="publicTierlistList" class="tierlist-list"></div>
        <div id="publicTierlistPagination" class="pagination"></div>

        <section id="adminSection" style="display:none; margin-top:8px;">
          <div class="section-title">관리자용 전체 TierList</div>
          <div id="adminTierlistList" class="tierlist-list"></div>
        </section>

        <div id="adminLoginArea" style="margin-top:6px; text-align:right; font-size:0.7rem; opacity:0.75;">
          <button id="adminLoginBtn" class="btn btn-ghost" style="padding:4px 8px;">관리자 로그인</button>
        </div>
      </div>
    </aside>

    <main class="main glass-card">
      <div class="header-row">
        <div>
          <div id="tierTitleDisplay" class="tier-title">Tierlist Select or Create</div>
          <div id="tierMetaDisplay" class="tier-meta"></div>
        </div>
        <div class="header-right">
          <div class="tier-meta info-text">
            카드 클릭 → 설명 보기 · 드래그앤드롭 → 티어 이동 · 점수는 1.0 ~ 10.0
          </div>
          <div style="display:flex; gap:6px; align-items:center; justify-content:flex-end;">
            <span id="modifyStateLabel" class="tier-meta" style="font-size:0.7rem; opacity:0.75;"></span>
            <button id="renameTierlistBtn" class="btn btn-ghost" style="display:none;">RENAME</button>
            <button id="modifyTierlistBtn" class="btn btn-ghost" style="display:none;">MODIFY</button>
            <button id="deleteTierlistBtn" class="btn btn-danger" style="display:none;">DELETE</button>
          </div>
        </div>
      </div>

      <section id="waitingSection" class="waiting-section" style="display:none;">
        <div class="waiting-header">
          <h3>대기리스트</h3>
        </div>
        <div id="waitingList" class="waiting-list" data-dropzone="waiting"></div>

        <form id="addItemForm" class="add-item-form">
          <input type="text" id="itemArtist" placeholder="아티스트" />
          <input type="text" id="itemTitle" placeholder="제목 (필수)" required />
          <input type="text" id="itemImageUrl" placeholder="커버 이미지 URL (선택)" />
          <input type="text" id="itemDesc" placeholder="간략 설명 (티어 이유 등)" />
          <button type="submit" class="btn btn-primary">대기리스트 추가</button>
        </form>
        <div class="info-text">
          대기리스트에 추가된 곡들은 드래그하여 티어표에 배정할 수 있습니다.
        </div>
        <div class="info-text">
          커버 이미지는 업로드 대신 URL로 넣도록 설정함. (예: Spotify/YouTube 썸네일 주소 등)
        </div>
      </section>

      <section>
        <div class="tier-board" id="tierBoard"></div>
      </section>
    </main>
  </div>

  <!-- 설명 모달 -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle"></div>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- 수정 모드 비밀번호 모달 -->
  <div id="authBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="authModalTitle">수정 모드 비밀번호 입력</div>
        <button type="button" class="modal-close" id="authCloseBtn">&times;</button>
      </div>
      <form id="authForm" class="modal-body">
        <div id="authHelpText" style="font-size:0.78rem; margin-bottom:8px; opacity:0.85;">
          이 티어리스트를 만든 사람이 입력했던 비밀번호 또는 관리자 비밀번호를 입력하면 수정 모드로 전환됩니다.
        </div>
        <input
          type="password"
          id="authPassword"
          placeholder="비밀번호"
          style="width:100%; padding:6px 8px; border-radius:999px; border:1px solid rgba(148,163,184,0.8); background:#111827; color:#e5e7eb; font-size:0.8rem; margin-bottom:8px;"
        />
        <div style="display:flex; justify-content:flex-end; gap:6px;">
          <button type="button" class="btn" id="authCancelBtn" style="background:#374151; color:#e5e7eb; padding:6px 10px;">취소</button>
          <button type="submit" class="btn btn-primary" style="margin-top:0; width:auto;">확인</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 관리자 로그인 모달 -->
  <div id="adminBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">관리자 로그인</div>
        <button type="button" class="modal-close" id="adminCloseBtn">&times;</button>
      </div>
      <form id="adminForm" class="modal-body">
        <div style="font-size:0.78rem; margin-bottom:8px; opacity:0.85;">
          관리자 비밀번호를 입력하면 전체 티어리스트 관리 창이 열립니다.
        </div>
        <input
          type="password" id="adminPassword"
          placeholder="관리자 비밀번호"
          style="width:100%; padding:6px 8px; border-radius:999px; border:1px solid rgba(148,163,184,0.8); background:#111827; color:#e5e7eb; font-size:0.8rem; margin-bottom:8px;"
        />
        <div style="display:flex; justify-content:flex-end; gap:6px;">
          <button type="button" class="btn" id="adminCancelBtn" style="background:#374151; color:#e5e7eb; padding:6px 10px;">취소</button>
          <button type="submit" class="btn btn-primary" style="margin-top:0; width:auto;">확인</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '';

    const tierBoardEl = document.getElementById('tierBoard');
    const waitingSectionEl = document.getElementById('waitingSection');
    const waitingListEl = document.getElementById('waitingList');
    const tierTitleDisplay = document.getElementById('tierTitleDisplay');
    const tierMetaDisplay = document.getElementById('tierMetaDisplay');

    const myTierlistListEl = document.getElementById('myTierlistList');
    const publicTierlistListEl = document.getElementById('publicTierlistList');
    const publicTierlistPaginationEl = document.getElementById('publicTierlistPagination');
    const adminSectionEl = document.getElementById('adminSection');
    const adminTierlistListEl = document.getElementById('adminTierlistList');
    const adminLoginArea = document.getElementById('adminLoginArea');
    const adminLoginBtn = document.getElementById('adminLoginBtn');

    const modifyTierlistBtn = document.getElementById('modifyTierlistBtn');
    const deleteTierlistBtn = document.getElementById('deleteTierlistBtn');
    const renameTierlistBtn = document.getElementById('renameTierlistBtn');
    const modifyStateLabel = document.getElementById('modifyStateLabel');

    const createForm = document.getElementById('createForm');
    const addItemForm = document.getElementById('addItemForm');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    const authBackdrop = document.getElementById('authBackdrop');
    const authForm = document.getElementById('authForm');
    const authPasswordInput = document.getElementById('authPassword');
    const authCloseBtn = document.getElementById('authCloseBtn');
    const authCancelBtn = document.getElementById('authCancelBtn');

    const adminBackdrop = document.getElementById('adminBackdrop');
    const adminForm = document.getElementById('adminForm');
    const adminPasswordInput = document.getElementById('adminPassword');
    const adminCloseBtn = document.getElementById('adminCloseBtn');
    const adminCancelBtn = document.getElementById('adminCancelBtn');

    let currentTierlistId = null;
    let currentTierType = null;
    let currentTierOwner = null;
    let currentTierPassword = null;
    let hasModifyPermission = false;

    let isAdmin = false;
    let adminToken = null;

    let publicTierlists = [];
    let myTierlists = [];
    let adminTierlists = [];

    let currentPublicPage = 1;
    const PUBLIC_PER_PAGE = 10;

    function getQueryParam(key) {
      return new URLSearchParams(window.location.search).get(key);
    }

    function updateAddItemFormForType(type) {
      const artistInput = document.getElementById('itemArtist');
      const titleInput = document.getElementById('itemTitle');
      if (type === 'artist') {
        artistInput.style.display = 'none';
        artistInput.value = '';
        titleInput.placeholder = '아티스트 이름 (필수)';
      } else {
        artistInput.style.display = '';
        titleInput.placeholder = '제목 (필수)';
      }
    }

    function updateModifyState() {
      const bodyEl = document.body;
      bodyEl.classList.toggle('read-only', !hasModifyPermission);

      const hasTier = !!currentTierlistId;

      if (!hasTier) {
        modifyTierlistBtn.style.display = 'none';
        deleteTierlistBtn.style.display = 'none';
        renameTierlistBtn.style.display = 'none';
      } else if (hasModifyPermission) {
        modifyTierlistBtn.style.display = 'none';
        deleteTierlistBtn.style.display = 'inline-flex';
        renameTierlistBtn.style.display = 'inline-flex';
      } else {
        modifyTierlistBtn.style.display = 'inline-flex';
        deleteTierlistBtn.style.display = 'none';
        renameTierlistBtn.style.display = 'none';
      }

      if (hasTier && hasModifyPermission) {
        waitingSectionEl.style.display = 'block';
      } else {
        waitingSectionEl.style.display = 'none';
      }

      const controlsDisabled = !hasTier || !hasModifyPermission;
      addItemForm.querySelectorAll('input, button').forEach(function (el) {
        el.disabled = controlsDisabled;
        el.style.opacity = controlsDisabled ? 0.5 : 1;
        el.style.cursor = controlsDisabled ? 'not-allowed' : '';
      });

      modifyStateLabel.textContent = hasTier
        ? (hasModifyPermission ? '수정 모드 ON' : '읽기 전용 · MODIFY 버튼으로 잠금 해제')
        : '';
    }

    function buildTierColumns() {
      tierBoardEl.innerHTML = '';

      const hofSection = document.createElement('section');
      hofSection.className = 'tier-section';
      hofSection.innerHTML =
        '<div class="tier-section-header hof">' +
          '<div class="tier-section-title">명예의 전당 (10.0)</div>' +
          '<div class="tier-section-sub">G.O.A.T</div>' +
        '</div>' +
        '<div class="tier-dropzone vertical" data-dropzone="tier" data-tier-int="10"></div>';
      tierBoardEl.appendChild(hofSection);

      for (let scoreInt = 9; scoreInt >= 1; scoreInt--) {
        const section = document.createElement('section');
        section.className = 'tier-section';
        section.innerHTML =
          '<div class="tier-section-header">' +
            '<div class="tier-section-title">' + scoreInt + '점대</div>' +
            '<div class="tier-section-sub">' + scoreInt + '.0 ~ ' + scoreInt + '.9</div>' +
          '</div>' +
          '<div class="tier-dropzone vertical" data-dropzone="tier" data-tier-int="' + scoreInt + '"></div>';
        tierBoardEl.appendChild(section);
      }
    }

    function createTrackCard(item) {
      const card = document.createElement('div');
      card.className = 'track-card';
      card.draggable = true;
      card.dataset.itemId = item.id;

      const img = document.createElement('img');
      img.className = 'track-cover';
      img.src = item.image_url || '';
      img.alt = item.title || '';
      if (!item.image_url) img.style.opacity = 0.5;

      const meta = document.createElement('div');
      meta.className = 'track-meta';
      const t = document.createElement('div');
      t.className = 'track-title';
      t.textContent = item.title || '(제목 없음)';
      const a = document.createElement('div');
      a.className = 'track-artist';
      a.textContent = item.artist || '';

      meta.appendChild(t);
      meta.appendChild(a);

      const score = document.createElement('div');
      score.className = 'track-score';
      score.textContent = (item.score != null) ? item.score.toFixed(1) : '-.-';

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'track-delete';
      delBtn.textContent = '✕';
      delBtn.addEventListener('click', async function (e) {
        e.stopPropagation();
        if (!hasModifyPermission) {
          alert('수정 모드가 아닙니다. 상단의 MODIFY 버튼을 눌러 비밀번호를 인증하세요.');
          return;
        }
        const ok = confirm('이 카드를 삭제하시겠습니까?');
        if (!ok) return;
        card.remove();
        await updateItem(item.id, { status: 'deleted', score: null });
      });

      card.appendChild(img);
      card.appendChild(meta);
      card.appendChild(score);
      card.appendChild(delBtn);

      if (item.status === 'waiting' || item.score == null) {
        const badge = document.createElement('div');
        badge.className = 'badge-waiting';
        badge.textContent = 'WAIT';
        card.appendChild(badge);
      }

      card.addEventListener('click', function (e) {
        if (e.target.classList.contains('track-delete')) return;
        e.stopPropagation();
        openDescriptionModal(item);
      });

      card.addEventListener('dragstart', function (e) {
        if (!hasModifyPermission) {
          e.preventDefault();
          return;
        }
        card.classList.add('dragging');
        e.dataTransfer.setData('text/plain', String(item.id));
      });
      card.addEventListener('dragend', function () {
        card.classList.remove('dragging');
      });

      return card;
    }

    function openDescriptionModal(item) {
      modalTitle.textContent = (item.title || '') + (item.artist ? ' – ' + item.artist : '');
      modalBody.textContent = item.description || '설명이 등록되어 있지 않습니다.';
      modalBackdrop.style.display = 'flex';
    }

    modalBackdrop.addEventListener('click', function (e) {
      if (e.target === modalBackdrop) modalBackdrop.style.display = 'none';
    });
    modalCloseBtn.addEventListener('click', function () {
      modalBackdrop.style.display = 'none';
    });

    function sortTierZone(dz) {
      const cards = Array.from(dz.querySelectorAll('.track-card'));
      cards.sort(function (a, b) {
        const sa = parseFloat(a.querySelector('.track-score').textContent) || 0;
        const sb = parseFloat(b.querySelector('.track-score').textContent) || 0;
        return sb - sa;
      });
      cards.forEach(function (c) { dz.appendChild(c); });
    }

    function setupDropzones() {
      const allDropzones = document.querySelectorAll('[data-dropzone]');
      allDropzones.forEach(function (dz) {
        dz.addEventListener('dragover', function (e) {
          if (!hasModifyPermission) return;
          e.preventDefault();
          dz.classList.add('drag-over');
        });
        dz.addEventListener('dragleave', function () {
          dz.classList.remove('drag-over');
        });
        dz.addEventListener('drop', function (e) {
          if (!hasModifyPermission) return;
          e.preventDefault();
          dz.classList.remove('drag-over');
          const itemId = e.dataTransfer.getData('text/plain');
          if (!itemId) return;
          handleDrop(parseInt(itemId, 10), dz);
        });
      });
    }

    async function handleDrop(itemId, dropzone) {
      if (!currentTierlistId) return;
      if (!hasModifyPermission) {
        alert('수정 모드가 아닙니다. 상단의 MODIFY 버튼을 눌러 비밀번호를 인증하세요.');
        return;
      }
      const isWaiting = dropzone.dataset.dropzone === 'waiting';
      const card = document.querySelector('.track-card[data-item-id="' + itemId + '"]');
      if (!card) return;

      if (isWaiting) {
        waitingListEl.appendChild(card);
        await updateItem(itemId, { status: 'waiting', score: null });
      } else {
        const tierInt = parseInt(dropzone.dataset.tierInt, 10);
        if (!tierInt) return;
        dropzone.appendChild(card);

        const currentScoreText = card.querySelector('.track-score').textContent;
        let defaultScore = tierInt + '.0';
        if (currentScoreText && currentScoreText !== '-.-') {
          defaultScore = currentScoreText;
        }

        let scoreStr = prompt('점수를 입력하십시오. (1.0 ~ 10.0, 소수 첫째 자리):', defaultScore);
        if (scoreStr == null) return;

        scoreStr = scoreStr.trim().replace(',', '.');
        let scoreNum = parseFloat(scoreStr);
        if (isNaN(scoreNum)) scoreNum = parseFloat(defaultScore);
        if (scoreNum < 1.0) scoreNum = 1.0;
        if (scoreNum > 10.0) scoreNum = 10.0;
        scoreNum = Math.round(scoreNum * 10) / 10;

        card.querySelector('.track-score').textContent = scoreNum.toFixed(1);
        const badge = card.querySelector('.badge-waiting');
        if (badge) badge.remove();

        await updateItem(itemId, { status: 'placed', score: scoreNum });
        sortTierZone(dropzone);
      }
    }

    async function updateItem(id, params) {
      if (!hasModifyPermission || !currentTierOwner || !currentTierPassword) {
        alert('수정 모드가 아닙니다. 상단의 MODIFY 버튼을 눌러 비밀번호를 인증하세요.');
        return;
      }
      const body = {
        name: currentTierOwner,
        password: currentTierPassword
      };
      if (typeof params.status === 'string') body.status = params.status;
      if (typeof params.score === 'number' || params.score === null) body.score = params.score;
      if (typeof params.description === 'string') body.description = params.description;

      const res = await fetch(API_BASE + '/api/items/' + id, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        alert('수정에 실패했습니다. 서버 상태 코드를 확인하세요.');
      }
    }

    async function deleteTierlistInModifyMode() {
      if (!hasModifyPermission || !currentTierlistId) {
        alert('삭제 권한이 없습니다. 상단의 MODIFY 버튼으로 먼저 수정 모드에 진입하세요.');
        return;
      }

      const ok = confirm('현재 티어리스트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.');
      if (!ok) return;

      try {
        const res = await fetch(API_BASE + '/api/tierlists/' + encodeURIComponent(currentTierlistId), {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentTierOwner,
            password: currentTierPassword
          })
        });
        if (!res.ok) {
          alert('티어리스트 삭제에 실패했습니다. 서버 로그를 확인하세요.');
          return;
        }
      } catch (err) {
        alert('서버 통신 중 오류가 발생했습니다.');
        return;
      }

      currentTierlistId = null;
      currentTierType = null;
      currentTierOwner = null;
      currentTierPassword = null;
      hasModifyPermission = false;

      tierTitleDisplay.textContent = 'Tierlist Select or Create';
      tierMetaDisplay.textContent = '';
      waitingListEl.innerHTML = '';
      document.querySelectorAll('.tier-dropzone').forEach(function (dz) { dz.innerHTML = ''; });
      updateModifyState();
      updateAddItemFormForType(null);
      await Promise.all([loadPublicTierlists(), loadMyTierlists(), isAdmin ? loadAdminTierlists() : Promise.resolve()]);
    }

    function openAuthModal() {
      if (!currentTierlistId || !currentTierOwner) {
        alert('먼저 티어리스트를 선택하십시오.');
        return;
      }
      authPasswordInput.value = '';
      authBackdrop.style.display = 'flex';
      authPasswordInput.focus();
    }

    modifyTierlistBtn.addEventListener('click', openAuthModal);

    deleteTierlistBtn.addEventListener('click', function () {
      if (!hasModifyPermission) {
        alert('수정 모드가 아닙니다. 상단의 MODIFY 버튼을 눌러 비밀번호를 인증하세요.');
        return;
      }
      deleteTierlistInModifyMode();
    });

    // 제목 수정 버튼
    renameTierlistBtn.addEventListener('click', async function () {
      if (!hasModifyPermission || !currentTierlistId || !currentTierOwner || !currentTierPassword) {
        alert('먼저 수정 모드로 전환하십시오.');
        return;
      }
      const currentTitle = tierTitleDisplay.textContent || '';
      const newTitle = prompt('새 티어리스트 제목을 입력하세요.', currentTitle);
      if (newTitle == null) return;
      const title = newTitle.trim();
      if (!title) {
        alert('제목은 비어 있을 수 없습니다.');
        return;
      }

      try {
        const res = await fetch(API_BASE + '/api/tierlists/' + encodeURIComponent(currentTierlistId), {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentTierOwner,
            password: currentTierPassword,
            title
          })
        });
        if (!res.ok) {
          alert('제목 수정에 실패했습니다.');
          return;
        }
        tierTitleDisplay.textContent = title;
        await Promise.all([loadPublicTierlists(), loadMyTierlists(), isAdmin ? loadAdminTierlists() : Promise.resolve()]);
      } catch (err) {
        alert('서버 통신 중 오류가 발생했습니다.');
      }
    });

    authCloseBtn.addEventListener('click', function () {
      authBackdrop.style.display = 'none';
    });
    authCancelBtn.addEventListener('click', function () {
      authBackdrop.style.display = 'none';
    });
    authBackdrop.addEventListener('click', function (e) {
      if (e.target === authBackdrop) {
        authBackdrop.style.display = 'none';
      }
    });

    // MODIFY 비밀번호 인증 (소유자 비번 또는 관리자 비번)
    authForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const pw = authPasswordInput.value.trim();
      if (!pw) return;

      if (!currentTierlistId || !currentTierOwner) {
        alert('먼저 티어리스트를 선택하십시오.');
        return;
      }

      try {
        const res = await fetch(
          API_BASE + '/api/tierlists/' + encodeURIComponent(currentTierlistId) + '/auth',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: currentTierOwner, password: pw })
          }
        );

        if (!res.ok) {
          if (res.status === 401 || res.status === 403) {
            alert('비밀번호가 일치하지 않습니다.');
          } else if (res.status === 404) {
            alert('티어리스트를 찾을 수 없습니다.');
          } else {
            alert('인증 중 오류가 발생했습니다.');
          }
          return;
        }

        const data = await res.json();
        currentTierPassword = pw;
        hasModifyPermission = true;
        updateModifyState();
        authBackdrop.style.display = 'none';
      } catch (err) {
        alert('서버 통신 중 오류가 발생했습니다.');
        return;
      }
    });

    // 관리자 로그인
    adminLoginBtn.addEventListener('click', function () {
      adminPasswordInput.value = '';
      adminBackdrop.style.display = 'flex';
      adminPasswordInput.focus();
    });
    adminCloseBtn.addEventListener('click', function () {
      adminBackdrop.style.display = 'none';
    });
    adminCancelBtn.addEventListener('click', function () {
      adminBackdrop.style.display = 'none';
    });
    adminBackdrop.addEventListener('click', function (e) {
      if (e.target === adminBackdrop) adminBackdrop.style.display = 'none';
    });

    adminForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const pw = adminPasswordInput.value.trim();
      if (!pw) return;

      try {
        const res = await fetch(API_BASE + '/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pw })
        });
        if (!res.ok) {
          if (res.status === 403) {
            alert('관리자 비밀번호가 일치하지 않습니다.');
          } else {
            alert('로그인 중 오류가 발생했습니다.');
          }
          return;
        }
        const data = await res.json();
        adminToken = data.token;
        isAdmin = true;
        adminBackdrop.style.display = 'none';
        adminLoginArea.style.display = 'none';
        adminSectionEl.style.display = 'block';
        await loadAdminTierlists();
      } catch (err) {
        alert('서버 통신 중 오류가 발생했습니다.');
        return;
      }
    });

    function makeTierlistClickHandler(id) {
      return function () {
        const url = new URL(window.location.href);
        url.searchParams.set('id', id);
        window.location.href = url.toString();
      };
    }

    function renderPublicTierlists() {
      publicTierlistListEl.innerHTML = '';
      publicTierlistPaginationEl.innerHTML = '';
      if (!publicTierlists || publicTierlists.length === 0) return;

      const totalPages = Math.ceil(publicTierlists.length / PUBLIC_PER_PAGE);
      if (currentPublicPage > totalPages) currentPublicPage = totalPages;

      const start = (currentPublicPage - 1) * PUBLIC_PER_PAGE;
      const slice = publicTierlists.slice(start, start + PUBLIC_PER_PAGE);

      slice.forEach(function (tl) {
        const div = document.createElement('div');
        div.className = 'tierlist-item';
        div.innerHTML =
          '<div>' +
            '<div>' + tl.title + '</div>' +
            '<div style="font-size:0.7rem; opacity:0.75;">by ' + tl.owner + '</div>' +
          '</div>' +
          '<span class="type">' + tl.type + '</span>';
        div.addEventListener('click', makeTierlistClickHandler(tl.id));
        publicTierlistListEl.appendChild(div);
      });

      if (totalPages > 1) {
        for (let p = 1; p <= totalPages; p++) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'page-btn' + (p === currentPublicPage ? ' active' : '');
          btn.textContent = String(p);
          btn.addEventListener('click', function () {
            currentPublicPage = p;
            renderPublicTierlists();
          });
          publicTierlistPaginationEl.appendChild(btn);
        }
      }
    }

    function renderMyTierlists() {
      myTierlistListEl.innerHTML = '';
      if (!myTierlists || myTierlists.length === 0) return;

      myTierlists.forEach(function (tl) {
        const div = document.createElement('div');
        div.className = 'tierlist-item';
        div.innerHTML =
          '<div>' +
            '<div>' + tl.title + '</div>' +
            '<div style="font-size:0.7rem; opacity:0.75;">내 티어리스트</div>' +
          '</div>' +
          '<span class="type">' + tl.type + '</span>';
        div.addEventListener('click', makeTierlistClickHandler(tl.id));
        myTierlistListEl.appendChild(div);
      });
    }

    function renderAdminTierlists() {
      adminTierlistListEl.innerHTML = '';
      if (!adminTierlists || adminTierlists.length === 0) return;

      adminTierlists.forEach(function (tl) {
        const row = document.createElement('div');
        row.className = 'tierlist-item';
        const left = document.createElement('div');
        left.innerHTML =
          '<div>' + tl.title + '</div>' +
          '<div style="font-size:0.7rem; opacity:0.75;">by ' + tl.owner + '</div>';
        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '4px';

        const typeSpan = document.createElement('span');
        typeSpan.className = 'type';
        typeSpan.textContent = tl.type + (tl.isPublic ? ' · 공개중' : '');
        right.appendChild(typeSpan);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-primary';
        btn.style.padding = '4px 8px';
        btn.style.fontSize = '0.7rem';

        if (tl.isPublic) {
          btn.textContent = '공개에서 내리기';
          btn.disabled = false;
          btn.addEventListener('click', async function (e) {
            e.stopPropagation();
            if (!confirm('이 티어리스트를 공개 목록에서 내리시겠습니까?')) return;
            await unpublishTierlist(tl.id);
          });
        } else {
          btn.textContent = '공개 티어표에 등재';
          btn.disabled = false;
          btn.addEventListener('click', async function (e) {
            e.stopPropagation();
            if (!confirm('이 티어리스트를 공개 티어표에 등재하시겠습니까?')) return;
            await publishTierlist(tl.id);
          });
        }

        right.appendChild(btn);

        row.appendChild(left);
        row.appendChild(right);
        row.addEventListener('click', makeTierlistClickHandler(tl.id));
        adminTierlistListEl.appendChild(row);
      });
    }

    async function loadPublicTierlists() {
      const res = await fetch(API_BASE + '/api/tierlists');
      if (!res.ok) return;
      publicTierlists = await res.json();
      currentPublicPage = 1;
      renderPublicTierlists();
    }

    async function loadMyTierlists() {
      const name = localStorage.getItem('tier_creator_name');
      const password = localStorage.getItem('tier_creator_password');
      if (!name || !password) {
        myTierlists = [];
        renderMyTierlists();
        return;
      }
      const res = await fetch(API_BASE + '/api/user-tierlists', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, password })
      });
      if (!res.ok) {
        myTierlists = [];
        renderMyTierlists();
        return;
      }
      myTierlists = await res.json();
      renderMyTierlists();
    }

    async function loadAdminTierlists() {
      if (!isAdmin || !adminToken) return;
      const res = await fetch(API_BASE + '/api/admin/tierlists', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminToken })
      });
      if (!res.ok) return;
      adminTierlists = await res.json();
      renderAdminTierlists();
    }

    async function publishTierlist(id) {
      if (!isAdmin || !adminToken) {
        alert('관리자 권한이 필요합니다.');
        return;
      }
      const res = await fetch(API_BASE + '/api/admin/tierlists/' + id + '/publish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminToken })
      });
      if (!res.ok) {
        alert('공개 티어표 등재에 실패했습니다.');
        return;
      }
      await Promise.all([loadAdminTierlists(), loadPublicTierlists()]);
    }

    async function unpublishTierlist(id) {
      if (!isAdmin || !adminToken) {
        alert('관리자 권한이 필요합니다.');
        return;
      }
      const res = await fetch(API_BASE + '/api/admin/tierlists/' + id + '/unpublish', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminToken })
      });
      if (!res.ok) {
        alert('공개 해제에 실패했습니다.');
        return;
      }
      await Promise.all([loadAdminTierlists(), loadPublicTierlists()]);
    }

    async function loadTierlist(id, preserveMode) {
      const res = await fetch(API_BASE + '/api/tierlists/' + id);
      if (!res.ok) {
        tierTitleDisplay.textContent = 'Tierlist Select or Create';
        tierMetaDisplay.textContent = '';
        currentTierlistId = null;
        currentTierType = null;
        currentTierOwner = null;
        currentTierPassword = null;
        hasModifyPermission = false;
        updateAddItemFormForType(null);
        updateModifyState();
        return;
      }
      const data = await res.json();
      currentTierlistId = data.tierlist.id;
      currentTierType = data.tierlist.type;
      currentTierOwner = data.tierlist.owner || '';

      if (!preserveMode) {
        currentTierPassword = null;
        hasModifyPermission = false;
      }
      updateAddItemFormForType(currentTierType);
      updateModifyState();

      tierTitleDisplay.textContent = data.tierlist.title;
      tierMetaDisplay.textContent = '타입: ' + data.tierlist.type + ' · by ' + data.tierlist.owner;

      waitingListEl.innerHTML = '';
      document.querySelectorAll('.tier-dropzone').forEach(function (dz) { dz.innerHTML = ''; });

      data.items.forEach(function (item) {
        if (item.status === 'deleted') return;
        const card = createTrackCard(item);
        if (item.status === 'waiting' || item.score == null) {
          waitingListEl.appendChild(card);
        } else {
          const intPart = Math.floor(item.score);
          let dz = document.querySelector('.tier-dropzone[data-tier-int="' + intPart + '"]');
          if (!dz) dz = document.querySelector('.tier-dropzone[data-tier-int="10"]');
          if (dz) dz.appendChild(card);
          else waitingListEl.appendChild(card);
        }
      });

      document.querySelectorAll('.tier-dropzone[data-dropzone="tier"]').forEach(sortTierZone);
      setupDropzones();
    }

    createForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const name = document.getElementById('creatorName').value.trim();
      const password = document.getElementById('creatorPassword').value.trim();
      const type = document.getElementById('tierType').value;
      const title = document.getElementById('tierTitle').value.trim();

      if (!name || !password || !title) return;

      const res = await fetch(API_BASE + '/api/tierlists', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, password: password, type: type, title: title })
      });
      if (!res.ok) {
        alert('생성에 실패했습니다. 입력 값을 확인하십시오.');
        return;
      }
      const out = await res.json();

      localStorage.setItem('tier_creator_name', name);
      localStorage.setItem('tier_creator_password', password);

      await loadMyTierlists();

      const url = new URL(window.location.href);
      url.searchParams.set('id', out.id);
      window.location.href = url.toString();
    });

    addItemForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!currentTierlistId) {
        alert('먼저 티어리스트를 선택하거나 생성하십시오.');
        return;
      }
      if (!hasModifyPermission || !currentTierOwner || !currentTierPassword) {
        alert('수정 모드가 아닙니다. 상단의 MODIFY 버튼을 눌러 비밀번호를 인증하세요.');
        return;
      }

      const artistInput = document.getElementById('itemArtist');
      const titleInput = document.getElementById('itemTitle');
      const imageUrl = document.getElementById('itemImageUrl').value.trim();
      const description = document.getElementById('itemDesc').value.trim();

      let artist = artistInput.value.trim();
      let title = titleInput.value.trim();

      if (currentTierType === 'artist') {
        artist = '';
        if (!title) {
          alert('아티스트 이름을 입력하십시오.');
          return;
        }
      } else {
        if (!title) return;
      }

      const res = await fetch(API_BASE + '/api/tierlists/' + currentTierlistId + '/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: currentTierOwner,
          password: currentTierPassword,
          artist: artist,
          title: title,
          imageUrl: imageUrl,
          description: description
        })
      });
      if (!res.ok) {
        alert('추가에 실패했습니다. 서버 상태 코드를 확인하세요.');
        return;
      }

      artistInput.value = '';
      titleInput.value = '';
      document.getElementById('itemImageUrl').value = '';
      document.getElementById('itemDesc').value = '';

      await loadTierlist(currentTierlistId, true);
    });

    (async function init() {
      buildTierColumns();
      updateModifyState();

      await Promise.all([loadPublicTierlists(), loadMyTierlists()]);

      const id = getQueryParam('id');
      if (id) {
        await loadTierlist(id, false);
      } else {
        currentTierlistId = null;
        currentTierType = null;
        currentTierOwner = null;
        currentTierPassword = null;
        hasModifyPermission = false;
        updateAddItemFormForType(null);
        updateModifyState();
      }

      const savedCreatorName = localStorage.getItem('tier_creator_name');
      const savedCreatorPw = localStorage.getItem('tier_creator_password');
      if (savedCreatorName) document.getElementById('creatorName').value = savedCreatorName;
      if (savedCreatorPw) document.getElementById('creatorPassword').value = savedCreatorPw;
    })();
  </script>
</body>
</html>
